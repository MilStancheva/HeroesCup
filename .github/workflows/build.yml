# This is a basic workflow to help you get started with Actions

name: Build

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on: 
  push:
    branches: [ master ] 
  pull_request:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.101
    - name: Install dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Test
      run: dotnet test --no-restore --verbosity normal
    dotnet-format:
      runs-on: ubuntu-latest
      steps:
        - name: Check for command
          id: command
          uses: xt0rted/slash-command-action@v1
          continue-on-error: true
          with:
            repo-token: ${{ secrets.GITHUB_TOKEN }}
            command: dotnet
            reaction-type: "eyes"
        - name: Get branch info
          if: steps.command.outputs.command-name
          id: comment-branch
          uses: xt0rted/pull-request-comment-branch@v1
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
        - name: Checkout repo
          if: steps.command.outputs.command-name
          uses: actions/checkout@v2
          with:
            ref: ${{ steps.comment-branch.outputs.ref }}
            persist-credentials: false
        - name: Restore dotnet tools
          if: steps.command.outputs.command-name
          uses: xt0rted/dotnet-tool-restore@v1
        - name: Run dotnet format
          if: steps.command.outputs.command-name && steps.command.outputs.command-arguments == 'format'
          id: format
          uses: xt0rted/dotnet-format@v1
          with:
            repo-token: ${{ secrets.GITHUB_TOKEN }}
            action: "fix"
            only-changed-files: true
        - name: Commit files
          if: steps.command.outputs.command-name && steps.command.outputs.command-arguments == 'format' && steps.format.outputs.has-changes == 'true'
          run: |
            git config --local user.name "github-actions[bot]"
            git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -a -m 'Automated dotnet-format update
            Co-authored-by: ${{ github.event.comment.user.login }} <${{ github.event.comment.user.id }}+${{ github.event.comment.user.login }}@users.noreply.github.com>'
        - name: Push changes
          if: steps.command.outputs.command-name && steps.command.outputs.command-arguments == 'format' && steps.format.outputs.has-changes == 'true'
          uses: ad-m/github-push-action@v0.5.0
          with:
            branch: ${{ steps.comment-branch.outputs.ref }}
            github_token: ${{ secrets.CI_ACCESS_TOKEN }}